---
title: "motifs-pipeline"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{motifs-pipeline}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Cette vignette montre comment utiliser les fonctions du package Motifs. Elle sert comme exemple de pipeline d’analyse des motifs d’un corpus.

### Introduction

Definissez d'abord les parametres et charger les librairies. Suivant les besoins, charger `explor` our `Factoshiny` pour la visualisation des ACP.

```{r setup}
# Charger le package (apres l'avoir installe)
library(MotiveR)

# installer and charger les packages externes
# libraries = c("Factoshiny", "FactoMineR", "explor")
# lapply(libraries, function(x) if (!(x %in% installed.packages())) {
#   install.packages(x, repos = "https://cran.rstudio.com")
# })
# lapply(libraries, library, quietly = TRUE, character.only = TRUE)

# manipulation de données
library(dplyr)

# Pour creer des ACP interactive
library(FactoMineR)
# Charger explor pour realiser des ACP interactive avec shiny.
library(explor)
# ou Factoshiny
library(Factoshiny)

# Parametres:
path <- system.file("extdata", "corpus-test", package = "MotiveR") # chemin du corpus
save_output <- FALSE # Sauvegarde resultats
overwrite <- FALSE # ecrase resultats precedents
n_grams <- 4 # longueur de la sequence n-gram
frequence <- 10 # filtre de frequence pour le retour aux textes (limite le temps de calcul)
len_context <- 4 # longueur du contexte d'analyse

```

### Preparation des donnees

#### Annotation et etiquetage

Lors de la premiere utilisation, le modele d'etiquetage est telecharge ce qui peut prendre un peu de temps.

- En deux fois: annotation et etiquetage du corpus

```{r annotation, eval=FALSE, message=FALSE, include=TRUE, results='hide'}
# UDpipe annotation
corpus_annote <- annotation_udpipe(path = path,
                                  save_output = save_output,
                                  overwrite = overwrite)
# transformation en motifs du corpus annote
corpus_motifs <- regex_corpus_udpipe(corpus = corpus_annote,
                                    save_output = save_output,
                                    overwrite = overwrite)
```

- Ou en une fois grâce la fonction `tag_motif_pipeline`

```{r tag_motif_pipeline, message=FALSE, results='hide'}
corpus_motifs <- tag_motif_pipeline(path = path,
                                   save_output = save_output,
                                   overwrite = overwrite)
```

#### Transformation en n-grams

```{r choix_nb_ngrams, message=FALSE, results='hide'}
corpus_grams <-  choix_nb_ngrams(
  n_grams,
  corpus = corpus_motifs,
  save_output = save_output,
  overwrite = overwrite
)
```

### Analyze

#### Histogrammes des motifs:
Avec 10 motifs:
```{r motifs_histogram, message=FALSE, results='hide', fig.width = 6, fig.height=3}
motifs_histogram(corpus_grams = corpus_grams,
                 nmots = 10,
                 freq = "rel")
```

#### Analyse TFIDF :
Transforme en table TFIDF et histogrammes des motifs dont le score est le plus eleve:

- 2 motifs sur un grqphique par oeuvre:
```{r motifs_tf_idf_sep, out.width="100%", message=FALSE, results='hide', fig.width = 8, fig.height=3}
corpus_words_ngrams <- motifs_tf_idf(
  corpus_grams = corpus_grams,
  save_output = save_output,
  overwrite = overwrite
)
plot_tf_idf(corpus_words_ngrams, n_motifs = 2, plot_type = "sep")
```


- 3 motifs sur un seul grqphique:
```{r motifs_tf_idf_group, out.width="100%", message=FALSE, results='hide', fig.width = 6, fig.height=4, out.width="100%"}
plot_tf_idf(corpus_words_ngrams, n_motifs = 3, plot_type = "group")
```

#### ACP avec FactoMineR:
```{r FactoMineRPCA, fig.width = 6, fig.height=3, out.width="100%"}
corpus_norm <- prepare_acp(corpus_grams = corpus_grams)
res.pca <- FactoMineR::PCA(corpus_norm, graph=TRUE)
```

#### Visualisation avec explor:
```{r explor, eval=FALSE, message=FALSE, include=TRUE, results='hide'}
res.shiny <- explor::explor(res.pca)
```

#### Visualisation avec Factoshiny:
```{r Factoshiny, eval=FALSE, message=FALSE, include=TRUE, results='hide'}
res.shiny <- Factoshiny::PCAshiny(res.pca)
```

#### ACP avec la fonction du package
```{r motifs_acp, out.width="100%", message=FALSE, results='hide', fig.width = 6, fig.height=3, out.width="100%"}
motifs_acp(plot_type = "var", corpus_grams = corpus_grams, n_motifs=10)
motifs_acp(plot_type = "motif", corpus_grams = corpus_grams, n_motifs=10)
motifs_acp(plot_type = "var+motif", corpus_grams = corpus_grams, n_motifs=10)
```

#### Realiser des statistiques sur les motifs
```{r motifs_stats, message=FALSE, results='hide'}
df_stats <- motifs_stats(
  corpus_grams = corpus_grams,
  save_output = save_output,
  overwrite = overwrite
)
```

#### Calcul de specificites
```{r calcul_specificites, message=FALSE, results='hide'}
calcul_spec_freq <- calcul_specificites(
  save_freq = TRUE,
  retrait_frequence_1 = TRUE,
  corpus_grams = corpus_grams,
  save_output = save_output,
  overwrite = overwrite
)
```

#### Retour aux textes
```{r retour_texte_specificites, message=FALSE, results='hide'}
retour_text_spec <- retour_texte_specificites(
  frequence = frequence,
  len_context = len_context,
  n_grams = n_grams,
  corpus_grams = corpus_grams,
  corpus_spec = calcul_spec_freq,
  save_output = save_output,
  overwrite = overwrite
)
```

#### Retour aux textes a partir d'un motif
```{r retour_texte_specificites_un_motif, message=FALSE, results='hide'}
retour_text_spec_un_motif <- retour_texte_specificites_un_motif(
  motif_cible = "le NC de le",
  len_context = len_context,
  n_grams = n_grams,
  corpus_grams = corpus_grams,
  corpus_spec = calcul_spec_freq,
  save_output = save_output,
  overwrite = overwrite
)
```


